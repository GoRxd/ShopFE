<div class="container mx-auto px-4 py-8">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
      Produkty
    </h1>
    <button 
      (click)="openCreate()" 
      class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors font-medium text-sm shadow-lg shadow-primary/20"
    >
      <lucide-icon [name]="PlusIcon" class="w-4 h-4"></lucide-icon>
      Dodaj Produkt
    </button>
  </div>

  <!-- Filters -->
  <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 p-4 mb-6 shadow-sm">
    <div class="max-w-md">
      <app-search-input
        [placeholder]="'Szukaj po nazwie...'"
        [value]="searchQuery()"
        (valueChange)="onSearchQuery($event)"
        inputClass="rounded-lg !py-2"
      ></app-search-input>
    </div>
  </div>

  <!-- Table -->
  <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
    <div class="overflow-x-auto custom-scrollbar">
      <table class="w-full text-left border-collapse">
        <thead class="bg-slate-50 dark:bg-slate-800/50 text-slate-500 dark:text-slate-400 text-xs uppercase font-semibold">
          <tr>
            <th class="px-6 py-4 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" (click)="sort('name')">
              <div class="flex items-center gap-2">
                Produkt
                <ng-container *ngTemplateOutlet="sortIcon; context: { col: 'name' }"></ng-container>
              </div>
            </th>
            <th class="px-6 py-4 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" (click)="sort('category')">
              <div class="flex items-center gap-2">
                Kategoria
                <ng-container *ngTemplateOutlet="sortIcon; context: { col: 'category' }"></ng-container>
              </div>
            </th>
            <th class="px-6 py-4 text-right cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" (click)="sort('price')">
              <div class="flex items-center justify-end gap-2">
                Cena
                <ng-container *ngTemplateOutlet="sortIcon; context: { col: 'price' }"></ng-container>
              </div>
            </th>
            <th class="px-6 py-4 text-center cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" (click)="sort('stock')">
              <div class="flex items-center justify-center gap-2">
                Magazyn
                <ng-container *ngTemplateOutlet="sortIcon; context: { col: 'stock' }"></ng-container>
              </div>
            </th>
            <th class="px-6 py-4 text-right">Akcje</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
          @if (isLoading()) {
            <tr>
              <td colspan="5" class="px-6 py-12 text-center text-slate-400">
                <div class="flex flex-col items-center gap-2">
                  <lucide-icon [name]="LoaderIcon" class="w-6 h-6 animate-spin"></lucide-icon>
                  <span>Ładowanie produktów...</span>
                </div>
              </td>
            </tr>
          } @else if (products().length === 0) {
            <tr>
              <td colspan="5" class="px-6 py-12 text-center text-slate-400">
                Brak produktów spełniających kryteria.
              </td>
            </tr>
          } @else {
            @for (product of products(); track product.id) {
              <tr (click)="openEdit(product)" class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors group cursor-pointer">
                <td class="px-6 py-4">
                  <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-lg bg-slate-100 dark:bg-slate-800 flex items-center justify-center overflow-hidden border border-slate-200 dark:border-slate-700">
                      @if (product.imageUrl) {
                        <img 
                          [src]="product.imageUrl" 
                          alt="" 
                          class="w-full h-full object-cover"
                        >
                      } @else {
                        <lucide-icon [name]="ImageIcon" class="w-6 h-6 text-slate-300"></lucide-icon>
                      }
                    </div>
                    <div>
                      <div class="font-medium text-slate-900 dark:text-white">{{ product.name }}</div>
                      <div class="text-xs text-slate-400">ID: {{ product.id }}</div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-300">
                  <span class="px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded text-xs font-medium">
                    {{ product.categoryName || 'Brak' }}
                  </span>
                </td>
                <td class="px-6 py-4 text-right font-medium text-slate-900 dark:text-white">
                  {{ product.price | currency:'PLN':'symbol':'1.2-2' }}
                </td>
                <td class="px-6 py-4 text-center">
                   <div class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                        [class.bg-green-100]="product.stockQuantity > 10"
                        [class.text-green-800]="product.stockQuantity > 10"
                        [class.bg-yellow-100]="product.stockQuantity <= 10 && product.stockQuantity > 0"
                        [class.text-yellow-800]="product.stockQuantity <= 10 && product.stockQuantity > 0"
                        [class.bg-red-100]="product.stockQuantity === 0"
                        [class.text-red-800]="product.stockQuantity === 0">
                      {{ product.stockQuantity }} szt.
                   </div>
                </td>
                <td class="px-6 py-4 text-right">
                  <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button 
                      (click)="openEdit(product); $event.stopPropagation()" 
                      class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors"
                      title="Edytuj"
                    >
                      <lucide-icon [name]="PencilIcon" class="w-4 h-4"></lucide-icon>
                    </button>
                    <button 
                      (click)="confirmDelete(product); $event.stopPropagation()" 
                      class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
                      title="Usuń"
                    >
                      <lucide-icon [name]="TrashIcon" class="w-4 h-4"></lucide-icon>
                    </button>
                  </div>
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
@if (isDeleteModalOpen()) {
  <div (click)="cancelDelete()" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm cursor-pointer">
  <div (click)="$event.stopPropagation()" class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in-95 duration-200 cursor-default">
    <div class="p-6 text-center">
      <div class="w-12 h-12 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
        <lucide-icon [name]="AlertIcon" class="w-6 h-6"></lucide-icon>
      </div>
      <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">Usunąć produkt?</h3>
      <p class="text-sm text-slate-500 mb-6">
        Czy na pewno chcesz usunąć produkt <span class="font-medium text-slate-900 dark:text-white">{{ productToDelete()?.name }}</span>?
        Tej operacji nie można cofnąć.
      </p>
      
      <div class="flex gap-3 justify-center">
        <button (click)="cancelDelete()" class="flex-1 px-4 py-2 text-sm text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-xl transition-colors">
          Anuluj
        </button>
        <button (click)="deleteProduct()" class="flex-1 px-4 py-2 text-sm bg-red-600 text-white hover:bg-red-700 rounded-xl transition-colors font-medium">
          Usuń
        </button>
      </div>
    </div>
  </div>
</div>
}

<ng-template #sortIcon let-col="col">
  @if (sortBy() === col) {
    @if (sortDirection() === 'asc') {
      <lucide-icon [name]="SortAscIcon" class="w-4 h-4 text-primary"></lucide-icon>
    } @else {
      <lucide-icon [name]="SortDescIcon" class="w-4 h-4 text-primary"></lucide-icon>
    }
  } @else {
    <lucide-icon [name]="SortIcon" class="w-4 h-4 text-slate-300"></lucide-icon>
  }
</ng-template>
